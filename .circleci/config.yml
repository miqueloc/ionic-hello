version: 2.1

jobs:
  unit-tests:
      docker: 
        - image: circleci/node:10.13.0
      steps:
        - checkout
        - run:
            name: npm install
            command: npm install
        - run:
            name: Runnning tests
            command: npm test
  build-android:
    ## Setup machine
    machine:
      java:
        version: 'oraclejdk8'
      node:
        version: v6.10.3
      ruby:
        version: 2.1.2
      environment:
        ANDROID_HOME: /usr/local/android-sdk-linux
    ## Setup dependencies
    dependencies:
      pre:
        - npm install -g ionic cordova
        - echo y | android update sdk --no-ui --all --filter tools,platform-tools,extra-google-m2repository,extra-google-google_play_services,extra-android-support,extra-android-m2repository,android-25
        - echo y | android update sdk --no-ui --all --filter build-tools-25.0.0

      cache_directories:
        - /usr/local/android-sdk-linux/tools
        - /usr/local/android-sdk-linux/build-tools/24.0.1

      post:
        - mkdir www
        - ionic cordova platform add android -Y --noresources

    test:
      pre:
        - npm install

      override:
        - ionic cordova build android -Y
        - cp -r platforms/android/build/outputs/apk $CIRCLE_ARTIFACTS
    # docker: 
    #   - image: circleci/android:api-28-alpha
    # steps:
    #   - checkout
    #   - run:
    #       name: remove folders
    #       command: rm -rf plugins/ platforms/ www/
    #   - run:
    #         name: npm install
    #         command: npm install
    #   - run:
    #       name: build android apk
    #       command: ionic cordova build android --no-interactive

workflows:
  version: 2.1
  pre-and-build:
    jobs:
      - unit-tests
      - build-android:
          requires:
            - unit-tests